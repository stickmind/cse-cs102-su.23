# 调试练习

在编程过程中，使用良好的调试策略至关重要。一个良好的调试策略包括如何使用 GDB 和 Valgrind 等调试工具并了解其内部机制，以及如何有效地利用它们在整个调试过程中查找、缩小范围并修复错误。现在是时候花点时间掌握 `gdb` 等调试器提供的强大功能，并学会一套周密且系统的调试方法！这是在调试时应该使用的一份核心清单（摘自 [GDB and Debugging](https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/resources/gdb)）。花一分钟时间阅读以下步骤：

- **观察漏洞行为**。如果你从没见过程序崩溃，你也很难修复漏洞。这也是你要进行[全面测试](https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/testing.html)的一个原因。
- **创建一个可复现输入**。创建一个可以触发程序失败的可靠输入将会提供巨大的帮助。
- **缩小检查范围**。调查整个程序或者一行一行执行通常来说不太可行。关于如何缩小检查的范围，以下给了一些建议：
	- 凭直觉，先从可能出错的位置开始，例如最近更改的代码或其他可疑的地方。
	- 使用二分查找来剖析。在中点设置一个断点，然后查看程序状态是否已经出错（这表明问题在前半部分）或看起来不错（从而需要将注意力集中在后半部分）。重复以上过程，以进一步缩小范围。
	- 在 Valgrind 下运行以识别任何潜在内存错误的根本原因。
	- 在 GDB 下运行以识别任何崩溃的根本原因
- **分析**。范围缩小后，就只需要检查少量代码，此时单步调试就变得非常可行。使用 `gdb` 查看变量值、控制流等，看看能发现什么。通过画图，也可能会有帮助。
- **设计实验并验证**。推断漏洞的根本原因并设计实验来验证你的假设。重复这个过程，直到找出根本原因。
- **修改代码消除错误**。修复是否成功应该根据你的实验和测试用例来验证。你应该能够解释漏洞的根本原因，以及测试和推论这些事实。

以上策略的一个关键原则是**不要随意更改代码**。类似科学实验，每次只改变一个变量。否则，这将使观察到的行为更加难以解释，并往往会引入新的错误。也就是说，如果你发现代码有错误，即使它和你现在正在跟踪的错误没有明显关联，你仍可能会停下来先修复它。但请遵守以上策略，使用可重现的输入来触发、修复并验证错误。该错误可能与原始错误有关或掩盖了原始错误，所以最好的措施是消除任何潜在的干扰源。

利用这种调试策略，你将可以有效地发现、理解并修复程序中出现的任何错误。鉴于此，我们提供了一个程序 `pig_latin.c` 供你练习以上策略，其中植入了一个潜在的漏洞。该程序的功能和课上讲解过的程序类似，只不过此处使用单纯的 C 语言重新实现了一遍。然而，它似乎在某些输入上崩溃了！特别注意代码最近所做的更改，在 `pig_latin` 函数的开头添加了几行代码，如果该单词无法翻译为 Pig Latin（以非小写字母的字符开头），则返回 `NULL`。但当运行一些自定义测试时，程序似乎无法通过。我们按照上面的调试流程来修复下！

- **观察漏洞行为**。这部分已经为你完成。在 `custom_tests` 中有一个自定义测试用例触发了程序崩溃。尝试使用 `sanitycheck` 运行看看！
- **创建一个可复现输入**。初始项目已经提供了一个触发崩溃的测试用例，但是输入比较复杂，对调试来说不太方便。尝试使用一个尽可能简单的输入来重现错误非常重要，这样可以更好地理解其输出，并且方便后续调试。根据目前提供的信息尝试在自定义测试中创建一个这样的输入。**先不要查看源码**！有时可以避免被不相关代码误导。
- **缩小检查范围**。现在的任务是缩小可能导致崩溃的代码范围。这对于缩短调试过程非常重要，例如如果错误仅潜伏在一个地方，则没必要逐步执行整个程序。幸运的是，GDB 可以为我们做一部分工作！如果你在 GDB 中运行程序，它会在发生崩溃的源码处暂停，让你查看程序的状态。现在尝试这样做：
  - 使用你在上一步中发现的测试用例在 GDB 中运行程序
  - 当程序崩溃时，你应该可以看到 GDB 警告出现段错误，以及导致崩溃的代码行！
  - 尝试使用 `backtrace` 命令查看崩溃时程序的调用栈——这将准确显示执行过程中发生崩溃的位置。你还可以打印出变量值并使用其他 GDB 命令来检查程序崩溃时的状态。
  - 非常好！现在我们已经缩小了导致问题的代码范围。
- **分析**。现在的工作是在这种状态下使用 GDB 进行探索，获取有关程序崩溃原因的更多信息。尝试打印出变量值，找出该行发生崩溃的原因。然后尝试使用 GDB 再次运行该程序，但应该在发生崩溃的函数开头设置断点，并单步调试，看看发生了什么。
- **设计实验并验证**。一旦对导致问题的原因有了某种假设，就应该设计一个测试输入，并使用 GDB 来验证你的假设。
- **修改代码消除错误**。现在集思广益并尝试修复这个问题。确保你准确理解正在做出的改变，以及为什么要做这些改变。运行之前的测试，确认更改是否解决了问题。至此，我们修复了这个错误——完美！

希望这个过程可以让你更好地了解如何遵循有效的调试策略，让调试的每一分钟都变得有意义。以下是一些其他关键要点：

- **良好的测试有助于发现错误**。正如步骤 1 所示，如果不先发现潜在的错误，你将无法施展你出色的调试技能！确保测试的完整性，尽早触发任何潜在的问题。 
- **尽可能让自己少做一些工作**。简单且可重现的输入是让调试和跟踪更容易的关键。如果输入非常复杂，那么追踪起来可能会非常困难！同样，缩小问题代码的范围可以让你只关注该代码块而不是整个程序。  
- **良好的风格可以使调试更容易**。合理的分解、注释以及代码组织，可以让程序更容易调试。想象一下，如果代码注释很糟糕，或者全部包含在一个函数中。那将浪费更多的时间！  
- **一个好的调试器是系统化的**。任何级别的程序员都花费大量时间进行调试。提高调试技能的关键是知道如何尽可能有效地规划你的时间，缩小调试范围并消除这些错误！
